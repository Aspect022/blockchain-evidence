<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>Notifications Demo - EVID-DGC</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="notifications.js"></script>
</head>
<body>
    <nav class="dashboard-nav">
        <div class="container">
            <div class="nav-content">
                <a href="index.html" class="nav-brand">EVID-DGC Notifications Demo</a>
                <div class="nav-items">
                    <span class="badge badge-demo">Demo Mode</span>
                    <button class="btn btn-outline btn-sm" onclick="window.location.href='index.html'">Back to Home</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-hero">
            <h1>Real-time Notifications Demo</h1>
            <p>Test the WebSocket notification system</p>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <div class="card-header">
                <h2>Connection Status</h2>
                <p>WebSocket connection and user status</p>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="testWallet">Test Wallet Address:</label>
                    <input type="text" id="testWallet" class="form-control" 
                           value="0x1234567890123456789012345678901234567890" 
                           placeholder="Enter wallet address">
                </div>
                <div class="form-actions">
                    <button id="connectBtn" class="btn btn-primary" onclick="connectToNotifications()">
                        <i data-lucide="wifi"></i>
                        Connect to Notifications
                    </button>
                    <button id="disconnectBtn" class="btn btn-outline" onclick="disconnectFromNotifications()" disabled>
                        <i data-lucide="wifi-off"></i>
                        Disconnect
                    </button>
                </div>
                <div id="connectionStatus" class="mt-3">
                    <span class="badge badge-warning">Not Connected</span>
                </div>
            </div>
        </div>

        <!-- Send Test Notifications -->
        <div class="card">
            <div class="card-header">
                <h2>Send Test Notifications</h2>
                <p>Create different types of notifications</p>
            </div>
            <div class="card-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="notificationTitle">Title:</label>
                        <input type="text" id="notificationTitle" class="form-control" 
                               value="Test Notification" placeholder="Notification title">
                    </div>
                    <div class="form-group">
                        <label for="notificationMessage">Message:</label>
                        <textarea id="notificationMessage" class="form-control" 
                                  placeholder="Notification message">This is a test notification from the demo system.</textarea>
                    </div>
                    <div class="form-group">
                        <label for="notificationType">Type:</label>
                        <select id="notificationType" class="form-control">
                            <option value="system">System</option>
                            <option value="evidence_upload">Evidence Upload</option>
                            <option value="evidence_verification">Evidence Verification</option>
                            <option value="evidence_assignment">Evidence Assignment</option>
                            <option value="comment">Comment</option>
                            <option value="mention">Mention</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-success" onclick="sendTestNotification()">
                        <i data-lucide="send"></i>
                        Send Notification
                    </button>
                    <button class="btn btn-warning" onclick="sendUrgentNotification()">
                        <i data-lucide="alert-triangle"></i>
                        Send Urgent
                    </button>
                    <button class="btn btn-info" onclick="sendMentionNotification()">
                        <i data-lucide="at-sign"></i>
                        Send @Mention
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification History -->
        <div class="card">
            <div class="card-header">
                <h2>Notification History</h2>
                <p>Recent notifications received</p>
            </div>
            <div class="card-body">
                <div class="form-actions mb-3">
                    <button class="btn btn-outline" onclick="loadNotificationHistory()">
                        <i data-lucide="refresh-cw"></i>
                        Refresh History
                    </button>
                    <button class="btn btn-outline" onclick="markAllAsRead()">
                        <i data-lucide="check-circle"></i>
                        Mark All Read
                    </button>
                    <button class="btn btn-outline" onclick="clearHistory()">
                        <i data-lucide="trash-2"></i>
                        Clear History
                    </button>
                </div>
                <div id="notificationHistory" class="notification-history">
                    <div class="text-center text-muted">No notifications yet</div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="card">
            <div class="card-header">
                <h2>Notification Settings</h2>
                <p>Configure notification preferences</p>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="soundEnabled" checked>
                        <span class="checkmark"></span>
                        Enable notification sounds
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="browserNotifications" checked>
                        <span class="checkmark"></span>
                        Enable browser notifications
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="toastNotifications" checked>
                        <span class="checkmark"></span>
                        Enable toast notifications
                    </label>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i data-lucide="save"></i>
                        Save Settings
                    </button>
                    <button class="btn btn-outline" onclick="requestBrowserPermission()">
                        <i data-lucide="bell"></i>
                        Request Browser Permission
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let currentWallet = null;
        let receivedNotifications = [];

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            loadSettings();
            loadNotificationHistory();
        });

        function connectToNotifications() {
            const wallet = document.getElementById('testWallet').value.trim();
            if (!wallet) {
                alert('Please enter a wallet address');
                return;
            }

            if (window.notificationManager) {
                window.notificationManager.connect(wallet);
                currentWallet = wallet;
                isConnected = true;
                
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="badge badge-success">Connected</span>';
                
                // Listen for notifications
                if (window.notificationManager.socket) {
                    window.notificationManager.socket.on('notification', (notification) => {
                        receivedNotifications.unshift(notification);
                        updateNotificationHistory();
                        showAlert(`New notification: ${notification.title}`, 'info');
                    });
                }
            }
        }

        function disconnectFromNotifications() {
            if (window.notificationManager) {
                window.notificationManager.disconnect();
                isConnected = false;
                currentWallet = null;
                
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="badge badge-warning">Not Connected</span>';
            }
        }

        async function sendTestNotification() {
            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;
            const type = document.getElementById('notificationType').value;
            const wallet = document.getElementById('testWallet').value;

            if (!title || !message || !wallet) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('/api/notifications/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userWallet: wallet,
                        title,
                        message,
                        type,
                        data: { demo: true, timestamp: new Date().toISOString() }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('Test notification sent!', 'success');
                } else {
                    showAlert('Failed to send notification', 'error');
                }
            } catch (error) {
                showAlert('Error sending notification: ' + error.message, 'error');
            }
        }

        async function sendUrgentNotification() {
            const wallet = document.getElementById('testWallet').value;
            await sendNotification(wallet, 'Urgent Alert', 'This is an urgent system notification requiring immediate attention!', 'urgent');
        }

        async function sendMentionNotification() {
            const wallet = document.getElementById('testWallet').value;
            await sendNotification(wallet, 'You were mentioned', '@user mentioned you in a case discussion', 'mention');
        }

        async function sendNotification(wallet, title, message, type) {
            try {
                const response = await fetch('/api/notifications/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userWallet: wallet,
                        title,
                        message,
                        type,
                        data: { demo: true, timestamp: new Date().toISOString() }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showAlert(`${type} notification sent!`, 'success');
                } else {
                    showAlert('Failed to send notification', 'error');
                }
            } catch (error) {
                showAlert('Error sending notification: ' + error.message, 'error');
            }
        }

        function loadNotificationHistory() {
            const historyDiv = document.getElementById('notificationHistory');
            
            if (receivedNotifications.length === 0) {
                historyDiv.innerHTML = '<div class="text-center text-muted">No notifications yet</div>';
                return;
            }

            historyDiv.innerHTML = receivedNotifications.map(notification => `
                <div class="notification-item ${!notification.is_read ? 'unread' : ''}">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-meta">
                        <span class="notification-type badge badge-${notification.type}">${notification.type}</span>
                        <span class="notification-time">${formatTime(notification.created_at)}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationHistory() {
            loadNotificationHistory();
        }

        function markAllAsRead() {
            receivedNotifications.forEach(n => n.is_read = true);
            updateNotificationHistory();
            showAlert('All notifications marked as read', 'success');
        }

        function clearHistory() {
            if (confirm('Clear all notification history?')) {
                receivedNotifications = [];
                updateNotificationHistory();
                showAlert('Notification history cleared', 'success');
            }
        }

        function saveSettings() {
            const settings = {
                soundEnabled: document.getElementById('soundEnabled').checked,
                browserNotifications: document.getElementById('browserNotifications').checked,
                toastNotifications: document.getElementById('toastNotifications').checked
            };
            
            localStorage.setItem('notificationPreferences', JSON.stringify(settings));
            
            if (window.notificationManager) {
                window.notificationManager.soundEnabled = settings.soundEnabled;
            }
            
            showAlert('Settings saved!', 'success');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('notificationPreferences') || '{}');
            
            document.getElementById('soundEnabled').checked = settings.soundEnabled !== false;
            document.getElementById('browserNotifications').checked = settings.browserNotifications !== false;
            document.getElementById('toastNotifications').checked = settings.toastNotifications !== false;
        }

        function requestBrowserPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    showAlert(`Browser notification permission: ${permission}`, 'info');
                });
            } else {
                showAlert('Browser notifications not supported', 'warning');
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
                max-width: 400px; background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
    </script>

    <style>
        .notification-history {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .notification-message {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .notification-type {
            font-size: 0.7rem;
        }

        .notification-time {
            color: #999;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .badge-demo {
            background: #17a2b8;
            color: white;
        }
    </style>
</body>
</html>